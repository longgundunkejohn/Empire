@page "/game/{gameId}/{playerId}"
@inject GameApi GameApi
@inject NavigationManager NavigationManager
@using Empire.Client.Services
@using Empire.Shared.Models
@using Empire.Shared.Models.Enums
@using Microsoft.AspNetCore.SignalR.Client
@inject GameHubService HubService

@if (gameState == null)

{
    <p>Loading game...</p>
}

else

{
    <div class="game-layout">

        <!-- Opponent Area -->
        <div class="opponent-hand-row">
            <div class="zone-label">Opponent Hand</div>
            <div class="card-row">
                @foreach (var _ in OpponentHand)

                {
                    <img src="images/Cards/cardback.png" class="card-image small" alt="Hidden card" />
                }
            </div>
        </div>

        <!-- Board Middle Area -->
        <div class="board-grid">
            <div class="morale-track">Morale: 20</div>

            <div class="territory-zones">
                @foreach (var boardCard in PlayerBoard)

                {

                    var card = GetCardFromDeck(boardCard.CardId);

                    if (card != null)

                    {
                        <div class="card-slot">
                            <CardImage Card="card" />
                        </div>
                    }

                }
            </div>

            <div class="initiative">
                <div>Initiative: ●</div>
                <button class="btn btn-sm">Pass</button>
            </div>
        </div>

        <!-- Player Area -->
        <div class="player-zones">

            <div class="units-zone">
                <div class="zone-label">Units</div>
                <div class="card-row">
                    @foreach (var card in PlayerHand)
                    {
                        <img src="@card.ImagePath"
                             class="card-image small"
                             draggable="true"
                             @ondragstart="(e) => OnDragStart(card.CardId)"
                        @oncontextmenu:preventDefault
                             @oncontextmenu="e => ShowZoomedCard(card, e)"
                             @onmousedown="e => { if (e.Button == 0 || e.Button == 2) HideZoomedCard(); }"
                             alt="@card.Name" />
                    }
                </div>
            </div>

            <div class="villagers-zone">
                <div class="zone-label">Villagers</div>
                <!-- Could list villagers separately here if tracked -->
            </div>

            <div class="bottom-bar">
                <div class="decks">
                    <CardBackImage DeckCount="@CivicDeckCount" CardBackPath="Cardbacks/civicCardback.png" OnDraw="DrawCivic" />
                    <CardBackImage DeckCount="@MilitaryDeckCount" CardBackPath="Cardbacks/armyCardback.png" OnDraw="DrawMilitary" />
                </div>

                <div class="chat-box">
                    <div class="chat-log">
                        @foreach (var msg in ChatLog)

                        {
                            <div><strong>@msg.PlayerId:</strong> @msg.Message</div>
                        }
                    </div>
                    <input class="form-control"
                           @bind="chatInput"
                           @bind:event="oninput"
                           @onkeydown="HandleChatKey"
                           placeholder="Type message or /shuffle..." />
                </div>
            </div>
        </div>

        <!-- Zoomed Card -->
        @if (ZoomedCard != null)

        {
            <div class="card-preview" style="top:@PreviewYpx; left:@PreviewXpx;">
                <img src="@ZoomedCard.ImagePath" alt="@ZoomedCard.Name" class="card-image" />
            </div>
        }
    </div>
}

@code {
    [Parameter] public string gameId { get; set; } = string.Empty;

    [Parameter] public string playerId { get; set; } = string.Empty;



    private GameState? gameState;

    private List<Card> AllCards = new();

    private HubConnection? hub;

    private Card? ZoomedCard = null;

    private string PreviewXpx = "0px";

    private string PreviewYpx = "0px";

    private string chatInput = string.Empty;

    private List<(string PlayerId, string Message)> ChatLog = new();

    private int? draggedCardId = null;



    private List<int> HandCardIds => gameState?.PlayerHands?.GetValueOrDefault(playerId) ?? new();

    private List<Card> PlayerHand => HandCardIds.Select(id => GetCardFromDeck(id)).Where(c => c != null).ToList()!;

    private List<Card> OpponentHand => gameState?.PlayerHands?.FirstOrDefault(p => p.Key != playerId).Value?.Select(id => new Card { CardId = id })?.ToList() ?? new();

    private List<BoardCard> PlayerBoard => gameState?.PlayerBoard?.GetValueOrDefault(playerId) ?? new();



    private int CivicDeckCount => gameState?.PlayerDecks?.GetValueOrDefault(playerId)?.Count(c => c.Type?.ToLowerInvariant() is "villager" or "settlement") ?? 0;

    private int MilitaryDeckCount => gameState?.PlayerDecks?.GetValueOrDefault(playerId)?.Count(c => c.Type?.ToLowerInvariant() is not ("villager" or "settlement")) ?? 0;



    protected override async Task OnInitializedAsync()

    {

        gameState = await GameApi.GetGameState(gameId);

        AllCards = gameState?.PlayerDecks.SelectMany(p => p.Value).ToList() ?? new();



        HubService.OnBoardUpdate += async (update) =>

        {

            if (update.GameId == gameId)

            {

                gameState!.PlayerBoard[update.PlayerId] = update.NewOrder.Select(id => new BoardCard(id)).ToList();

                StateHasChanged();

            }

        };



        await HubService.ConnectAsync(gameId);

    }



    private async Task RefreshGameState()

    {

        gameState = await GameApi.GetGameState(gameId);

        AllCards = gameState?.PlayerDecks?.SelectMany(p => p.Value).ToList() ?? new();

        StateHasChanged();

    }



    private async Task DrawCivic() => await Draw("civic");

    private async Task DrawMilitary() => await Draw("military");



    private async Task Draw(string type)

    {

        await GameApi.DrawCard(gameId, playerId, type);

        await RefreshGameState();

    }



    private async Task ShuffleDeck()

    {

        var move = new GameMove { PlayerId = playerId, MoveType = "ShuffleDeck" };

        await GameApi.SubmitMove(gameId, move);

        ChatLog.Add((playerId, "🔀 shuffled their deck."));

        await RefreshGameState();

    }



    private async Task HandleChatKey(KeyboardEventArgs e)

    {

        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(chatInput))

        {

            var message = chatInput.Trim();

            if (message.StartsWith("/"))

                await HandleChatCommand(message);

            else

                ChatLog.Add((playerId, message));



            chatInput = string.Empty;

            StateHasChanged();

        }

    }



    private async Task HandleChatCommand(string command)

    {

        switch (command.ToLowerInvariant())

        {

            case "/shuffle":

                await ShuffleDeck();

                break;

            default:

                ChatLog.Add((playerId, $"❓ Unknown command: {command}"));

                break;

        }

    }



    private void ShowZoomedCard(Card card, MouseEventArgs e)

    {

        const int previewWidth = 300;

        const int previewHeight = 420;

        const int screenWidth = 1920;

        const int screenHeight = 1080;



        int offsetX = (e.ClientX + previewWidth + 30 > screenWidth) ? -previewWidth - 20 : 20;

        int offsetY = (e.ClientY + previewHeight + 30 > screenHeight) ? -previewHeight - 20 : 20;



        PreviewXpx = $"{e.ClientX + offsetX}px";

        PreviewYpx = $"{e.ClientY + offsetY}px";

        ZoomedCard = card;

    }



    private void HideZoomedCard() => ZoomedCard = null;

    private Card? GetCardFromDeck(int id) => AllCards.FirstOrDefault(c => c.CardId == id);

    private void OnDragStart(int cardId) => draggedCardId = cardId;



    private async Task OnCardDrop()

    {

        if (!draggedCardId.HasValue) return;



        var currentBoard = PlayerBoard;

        currentBoard.RemoveAll(c => c.CardId == draggedCardId.Value);

        currentBoard.Add(new BoardCard(draggedCardId.Value));



        var update = new BoardPositionUpdate

            {

                GameId = gameId,

                PlayerId = playerId,

                NewOrder = currentBoard.Select(c => c.CardId).ToList()

            };



        await HubService.SendBoardUpdate(gameId, update);

        draggedCardId = null;

        StateHasChanged();

    }
}
